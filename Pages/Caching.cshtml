@page
@model CachingModel
@{
    ViewData["Title"] = "Memory Caching";
}

<div class="container mt-4">
    <h2>Memory Caching</h2>
    <p class="lead">Demonstrates in-memory caching with cache hit/miss tracking.</p>

    <div class="card mb-3">
        <div class="card-header bg-light">
            <h5 class="mb-0">Configuration</h5>
        </div>
        <div class="card-body">
            <pre><code>// In Program.cs
services.AddDeliveryClient(options =>
{
    options.EnvironmentId = "your-environment-id";
})
.WithMemoryCache(TimeSpan.FromMinutes(5));</code></pre>
            <p class="mt-2 mb-0">
                <strong>Caching Status:</strong>
                @if (Model.CachingEnabled)
                {
                    <span class="badge bg-success">Enabled</span>
                    <span class="text-muted">(5 minute expiration)</span>
                }
                else
                {
                    <span class="badge bg-danger">Disabled</span>
                }
            </p>
        </div>
    </div>

    @if (!Model.CachingEnabled)
    {
        <div class="alert alert-warning">
            <strong>Warning:</strong> Caching is currently disabled. All requests will hit the Kontent.ai API directly.
            To enable caching, add <code>.WithMemoryCache(TimeSpan.FromMinutes(5))</code> in Program.cs.
        </div>
    }

    @if (Model.FirstCallSuccess)
    {
        <div class="card mb-3">
            <div class="card-header @(Model.FirstCallFromCache ? "bg-success" : "bg-primary") text-white">
                <h5 class="mb-0">First Call @(Model.FirstCallFromCache ? "(Cache Hit)" : "(Cache Miss)")</h5>
            </div>
            <div class="card-body">
                <p><strong>Item:</strong> @Model.FirstCallItem!.System.Name</p>
                <p><strong>Execution Time:</strong> @Model.FirstCallTime.TotalMilliseconds.ToString("F2") ms</p>
                <p><strong>Type:</strong> <code>@Model.FirstCallItem.System.Type</code></p>
                <p><strong>Served From Cache:</strong>
                    @if (Model.FirstCallFromCache)
                    {
                        <span class="badge bg-success">Yes</span>
                    }
                    else
                    {
                        <span class="badge bg-warning">No</span>
                    }
                </p>
                <p class="text-muted mb-0">
                    @if (Model.FirstCallFromCache)
                    {
                        <text>This response was served from memory cache.</text>
                    }
                    else
                    {
                        <text>This call fetched data from the Kontent.ai API.</text>
                    }
                </p>
            </div>
        </div>
    }

    @if (Model.SecondCallSuccess)
    {
        <div class="card mb-3">
            <div class="card-header @(Model.SecondCallFromCache ? "bg-success" : "bg-primary") text-white">
                <h5 class="mb-0">Second Call @(Model.SecondCallFromCache ? "(Cache Hit)" : "(Cache Miss)")</h5>
            </div>
            <div class="card-body">
                <p><strong>Item:</strong> @Model.SecondCallItem!.System.Name</p>
                <p><strong>Execution Time:</strong> @Model.SecondCallTime.TotalMilliseconds.ToString("F2") ms</p>
                <p><strong>Served From Cache:</strong>
                    @if (Model.SecondCallFromCache)
                    {
                        <span class="badge bg-success">Yes</span>
                    }
                    else
                    {
                        <span class="badge bg-warning">No</span>
                    }
                </p>
                @if (Model.SecondCallFromCache && Model.SpeedImprovement > 1)
                {
                    <p><strong>Speed Improvement:</strong> @Model.SpeedImprovement.ToString("F1")x faster than first call</p>
                }
                <p class="text-muted mb-0">
                    @if (Model.SecondCallFromCache)
                    {
                        <text>This response was served from memory cache.</text>
                    }
                    else
                    {
                        <text>This call fetched data from the Kontent.ai API.</text>
                    }
                </p>
            </div>
        </div>

        @if (Model.SecondCallFromCache && Model.SpeedImprovement > 1)
        {
            <div class="alert alert-success">
                <strong>Cache Working!</strong> The second call was @Model.SpeedImprovement.ToString("F1")x faster, demonstrating that caching is active.
            </div>
        }
    }

    @if (Model.ThirdCallSuccess)
    {
        <div class="card mb-3">
            <div class="card-header @(Model.ThirdCallFromCache ? "bg-success" : "bg-primary") text-white">
                <h5 class="mb-0">Third Call @(Model.ThirdCallFromCache ? "(Cache Hit)" : "(Cache Miss)")</h5>
            </div>
            <div class="card-body">
                <p><strong>Execution Time:</strong> @Model.ThirdCallTime.TotalMilliseconds.ToString("F2") ms</p>
                <p><strong>Served From Cache:</strong>
                    @if (Model.ThirdCallFromCache)
                    {
                        <span class="badge bg-success">Yes</span>
                    }
                    else
                    {
                        <span class="badge bg-warning">No</span>
                    }
                </p>
                <p class="text-muted mb-0">
                    @if (Model.ThirdCallFromCache)
                    {
                        <text>Subsequent calls continue to use the cache until expiration.</text>
                    }
                    else
                    {
                        <text>This call fetched data from the Kontent.ai API.</text>
                    }
                </p>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">
            <strong>Error:</strong> @Model.ErrorMessage
        </div>
    }

    <div class="card mt-3">
        <div class="card-header bg-light">
            <h5 class="mb-0">Cache Behavior</h5>
        </div>
        <div class="card-body">
            <ul class="mb-0">
                <li><strong>Automatic:</strong> Once configured, all queries are automatically cached</li>
                <li><strong>Key Generation:</strong> Cache keys are built from query parameters</li>
                <li><strong>Expiration:</strong> Cached items expire after the configured duration (5 min)</li>
                <li><strong>Memory Cache:</strong> Suitable for single-instance applications</li>
                <li><strong>Distributed Cache:</strong> For multi-instance deployments, use Redis or SQL Server</li>
            </ul>
        </div>
    </div>

    <div class="mt-3">
        <a href="/Caching" class="btn btn-primary">Refresh Page (Test Cache)</a>
    </div>
</div>
